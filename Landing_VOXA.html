<!DOCTYPE html>
<!-- تم تغيير هذا السطر لإضافة كلاس 'light' افتراضياً لضمان البدء في الوضع الفاتح -->
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Haider - Exception Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* * ---------- CYBER NEON ROOT & RESET (V6 - Default Light) ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600;700&display=swap');
    
    :root{
      /* Default to Dark Mode Variables */
      --bg:#030712; 
      --accent:#00F0FF; 
      --accent-secondary: #FF5733; 
      --accentGlow:0 0 10px var(--accent), 0 0 20px rgba(0,240,255,.5);
      --fontH:'Orbitron',sans-serif;
      --fontB:'Inter',sans-serif;
      --text-color:#E5E7EB;
      --card-bg:#0F172A; 
      --dash-bg:rgba(0,240,255,.08);
      --dash-border:rgba(0,240,255,.3);
    }
    /* Light Mode Overrides (Applied via .light class on body) */
    body.light{
      --bg:#f8f9fa;
      --accent:#007BFF; 
      --accent-secondary: #00AFFF; 
      --accentGlow:none; 
      --text-color:#212529;
      --card-bg:#ffffff;
      --dash-bg:rgba(0,123,255,.1);
      --dash-border:rgba(0,123,255,.5);
    }

    /* Base Styling */
    *{margin:0;padding:0;box-sizing:border-box;font-family:var(--fontB);}
    body{background:var(--bg);color:var(--text-color);overflow-x:hidden;min-height:100vh;position:relative; transition: background .5s, color .5s;}
    a{text-decoration:none;color:inherit;}
    button{cursor:pointer;border:none;background:none;font:inherit;color:inherit;}

    /* ---------- DYNAMIC BACKGROUND (Particle Flow) ---------- */
    #particles{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;}
    canvas{display:block;width:100%;height:100%;}

    /* ---------- NAV BAR V6 ---------- */
    nav{position:fixed;top:0;width:100%;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;z-index:1000; background: rgba(3, 7, 18, 0.7); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,240,255,0.1); transition: background .5s;}
    body.light nav{background: rgba(248, 249, 250, 0.8); border-bottom-color: rgba(0,123,255,0.3);}

    .logo-group{display: flex; flex-direction: column; align-items: flex-end;}
    .logo{font-family:var(--fontH);font-size:1.4rem;letter-spacing:3px;color:var(--accent);text-shadow:var(--accentGlow);}
    .owner-name{font-size: 0.85rem; color: #7b8599; margin-top: -5px; transition: color .5s;}

    /* ---------- THEME TOGGLE STYLING V6 ---------- */
    .themeToggle{width:50px;height:24px;background:var(--card-bg);border-radius:24px;position:relative;transition:.5s;cursor:pointer; border: 1px solid var(--dash-border);}
    /* Position for Dark Mode (right) */
    .themeToggle::after{content:'';position:absolute;width:20px;height:20px;background:var(--accent);border-radius:50%;top:2px;right:2px;transition:.5s; box-shadow: var(--accentGlow);}
    /* Toggle BG and After for Light Mode */
    body.light .themeToggle{background:#ddd;}
    body.light .themeToggle::after{transform:translateX(-26px);background:var(--accent);box-shadow: none;}
    
    /* ---------- HERO SECTION V6 ---------- */
    .hero{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:0 1rem;}
    .hero h1{font-family:var(--fontH);font-size:clamp(2.5rem,6vw,5rem);margin-bottom:1.5rem;text-shadow:var(--accentGlow);}
    .hero p{font-size:1.3rem;margin-bottom:3rem;opacity:.9;}
    .ctaWrap{display:flex;gap:1.5rem;flex-wrap:wrap;justify-content:center;}
    
    /* CTA Button Styles */
    .cta{padding:.9rem 2.2rem;border:2px solid var(--accent);border-radius:8px;font-weight:700;transition:.3s;position:relative;overflow:hidden;color:var(--text-color); background: transparent;}
    .cta:hover{background:var(--accent);color:var(--bg);box-shadow:var(--accentGlow); transform: translateY(-3px);}
    .cta.secondary{border-color:#475569;color:#94a3b8; background: var(--card-bg);}
    .cta.secondary:hover{background:#475569;color:#fff;border-color:#475569;box-shadow:none; transform: translateY(-3px);}
    
    /* Light Mode Button Colors */
    body.light .cta{color:var(--text-color);border-color:var(--accent);}
    body.light .cta:hover{background:var(--accent);color:#fff;border-color:var(--accent); box-shadow: 0 4px 10px rgba(0,123,255,0.3);}
    body.light .cta.secondary{border-color:#ccc;color:#555; background: #eee;}

    /* ---------- SECTIONS WRAPPER V6 ---------- */
    main{position:relative;padding:6rem 1rem;max-width:1200px;margin:auto;}
    section{display:none;animation:fadeIn .8s forwards;}
    section.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}

    /* Titles */
    .section-title{font-family:var(--fontH);margin-bottom:2.5rem;text-align:center;color:var(--accent); text-shadow: var(--accentGlow); font-size: 2.5rem;}
    .section-subtitle{text-align:center; margin-bottom: 2rem; opacity: .8;}

    /* ---------- GOAL DASHBOARD V6 (5 Metrics) ---------- */
    .dash{background:var(--card-bg);border:1px solid var(--dash-border);border-radius:12px;padding:2.5rem;margin-bottom:4rem; box-shadow: 0 0 15px rgba(0,240,255,.15);}
    .goal{margin-bottom:1.5rem;}
    .goal label{display:flex;justify-content:space-between;margin-bottom:.5rem;font-size:1rem; font-weight: 600;}
    .bar{height:12px;background:#1e293b;border-radius:6px;overflow:hidden;position:relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);}
    .bar span{position:absolute;left:0;top:0;height:100%;background:var(--accent);box-shadow:var(--accentGlow);width:0;transition:width 1.5s ease-out; border-radius: 6px;}
    body.light .bar{background:#e9ecef;}

    /* ---------- MENTALITY MAP & SERVICES V6 ---------- */
    .cards{display:grid;gap:1.5rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
    .card{background:var(--card-bg);border:1px solid var(--dash-border);padding:1.5rem;border-radius:8px;transition:.4s;transform-style:preserve-3d; color: var(--text-color); box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    .card:hover{transform:translateY(-5px) scale(1.02);border-color:var(--accent);}
    .card h3{font-family:var(--fontH);margin-bottom:.6rem;color:var(--accent); font-size: 1.2rem;}
    .card p{opacity: .8;}
    body.light .card{box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
    
    /* ---------- CONTACT / FORM STYLING V6 ---------- */
    .lockContact{text-align:center;margin-top:3rem;}
    .lockContact input{width:220px;padding:.8rem;border:1px solid var(--accent);background:transparent;color:var(--accent);border-radius:6px;margin-left:.5rem; text-align: right; transition: .3s;}
    .lockContact input:focus{outline:none; box-shadow: 0 0 8px var(--accent);}
    .lockContact button{padding:.8rem 1.6rem;background:var(--accent);color:var(--bg);border-radius:6px; font-weight: 700; transition: .3s;}
    
    #contactForm, #business form{background:var(--card-bg);border:1px solid var(--dash-border);border-radius:8px;padding:2rem;margin-top:1.5rem; max-width: 600px; margin-left: auto; margin-right: auto;}
    #contactForm input, #contactForm textarea, #business input, #business textarea{width:100%;padding:.8rem;margin:.6rem 0;background:var(--bg);border:1px solid #475569;border-radius:4px;color:var(--text-color);text-align: right; transition: .3s;}
    #contactForm input:focus, #contactForm textarea:focus, #business input:focus, #business textarea:focus{outline:none; border-color: var(--accent); box-shadow: 0 0 5px rgba(0,240,255,.5);}
    #contactForm button, #business button{background:var(--accent);color:var(--bg);padding:.8rem 1.6rem;border-radius:6px;font-weight:700;}
    body.light #contactForm, body.light #business form{background:#fff;}
    body.light #contactForm input, body.light #contactForm textarea, body.light #business input, body.light #business textarea{background:#f0f4f8;border-color:#ccc;color:#111;}
    #contactForm{display:none;}
    
    /* ---------- AI CHAT BUTTON & WINDOW V6 (RADICALLY IMPROVED) ---------- */
    .aiChat{position:fixed;bottom:25px;right:25px;width:60px;height:60px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:var(--accentGlow);z-index:1000;cursor:pointer; transition: .3s;}
    .aiChat:hover{transform: scale(1.05); box-shadow: 0 0 15px var(--accent);}
    .aiChat svg{width:32px;height:32px;stroke:var(--bg); fill: none; transition: .3s;} 
    .chatWindow{position:fixed;bottom:100px;right:25px;width:360px;height:480px;background:var(--card-bg);border:2px solid var(--accent);border-radius:12px;display:none;flex-direction:column;z-index:1001;box-shadow:var(--accentGlow);}
    body.light .chatWindow{box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
    
    .chatHeader{padding:.8rem 1rem;background:var(--accent);color:var(--bg);font-weight:700;display:flex;justify-content:space-between;align-items:center; border-radius: 10px 10px 0 0; font-family: var(--fontH);}
    .chatClose{cursor:pointer;font-size:1.5rem; line-height: 1;}
    
    .chatBody{flex:1;padding:1rem;overflow-y:auto;font-size:.95rem; line-height: 1.5; background: var(--bg);}
    .chatBody div{direction: rtl; margin-bottom: 1rem;} 

    /* Chat Messages Styling */
    .msg-ai {
        text-align: right;
        background: var(--dash-bg); 
        border-radius: 8px 8px 0 8px;
        padding: 0.7rem;
        border-left: 3px solid var(--accent);
        color: var(--text-color);
    }
    .msg-user {
        text-align: left;
        background: transparent;
        padding: 0.7rem 0.5rem;
        color: var(--text-color);
        font-weight: 600;
        opacity: 0.9;
    }

    .msg-user b, .msg-ai b { color: var(--accent-secondary); font-family: var(--fontH);}
    .chatBody small { display: block; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px dashed rgba(255,255,255,.1); font-size: 0.75rem; color: #94a3b8 !important; text-align: left; direction: ltr;}
    .chatBody small a { color: var(--accent) !important; text-decoration: none; transition: color .2s;}
    .chatBody small a:hover { color: var(--accent-secondary) !important; text-decoration: underline;}

    .chatInput{display:flex;padding:.8rem 1rem;border-top:1px solid var(--dash-border); background: var(--card-bg); border-radius: 0 0 10px 10px;}
    .chatInput input{flex:1;padding:.6rem;background:var(--bg);border:1px solid #475569;border-radius:6px;color:var(--text-color); text-align: right; margin-left: .5rem;}
    .chatInput button{padding:.6rem 1rem;background:var(--accent);color:var(--bg);border-radius:6px; font-weight: 700;}

    /* ---------- RESPONSIVE V6 ---------- */
    @media(max-width:768px){
      nav{padding:1rem;}
      .hero h1{font-size: 3rem;}
      .ctaWrap{gap:1rem;}
      .cards{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
      .chatWindow{width:95%;right:2.5%;bottom:90px;}
      .aiChat{bottom:20px; right: 20px;}
      main{padding: 4rem 1rem;}
    }
  </style>
</head>
<!-- تم إضافة كلاس 'light' هنا لجعله الوضع الافتراضي -->
<body class="light">
  <div id="particles"><canvas id="canvas"></canvas></div>

  <nav>
    <div class="logo-group">
        <div class="logo">EXCEPTION MAKER</div>
        <div class="owner-name">موقع Haider الشخصي</div> 
    </div>
    <div class="themeToggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle Theme"></div> 
  </nav>

  <header class="hero">
    <h1>رجل الهدف</h1>
    <p>مصمم غرافيك (Graphic Designer) وباحث عن التميز.</p>
    <div class="ctaWrap">
      <button class="cta" onclick="showView('vision')">الرؤية الشخصية</button>
      <button class="cta secondary" onclick="showView('business')">الخدمات والتواصل</button>
    </div>
  </header>

  <main>
    <section id="vision" class="active">
      <h2 class="section-title">Goal Dashboard</h2>
      
      <div class="dash">
        
        <!-- Goal 1: اللياقة البدنية (40%) -->
        <div class="goal">
          <label><span>اللياقة البدنية</span><span data-value="40">0%</span></label>
          <div class="bar"><span data-width="40"></span></div>
        </div>

        <!-- Goal 2: المشروع الفني (70%) -->
        <div class="goal">
          <label><span>المشروع الفني</span><span data-value="70">0%</span></label>
          <div class="bar"><span data-width="70"></span></div>
        </div>

        <!-- Goal 3: التحدي الفكري (87%) -->
        <div class="goal">
          <label><span>التحدي الفكري</span><span data-value="87">0%</span></label>
          <div class="bar"><span data-width="87"></span></div>
        </div>

        <!-- NEW Goal 4: إتقان الأدوات التقنية (90%) -->
        <div class="goal">
          <label><span>إتقان الأدوات التقنية (Design Software Mastery)</span><span data-value="90">0%</span></label>
          <div class="bar"><span data-width="90"></span></div>
        </div>

        <!-- NEW Goal 5: الاحترافية في التسليم (80%) -->
        <div class="goal">
          <label><span>الاحترافية في التسليم (Delivery Professionalism)</span><span data-value="80">0%</span></label>
          <div class="bar"><span data-width="80"></span></div>
        </div>
      </div>

      <h2 class="section-title">The Mentality</h2>
      <p class="section-subtitle">المبادئ الأساسية التي تحكم العمل والحياة.</p>
      
      <div class="cards">
        <div class="card">
          <h3>الانضباط الذاتي</h3>
          <p>الالتزام بالروتين اليومي دون رقيب خارجي هو مفتاح النجاح المستدام.</p>
        </div>
        <div class="card">
          <h3>التعليم المستمر</h3>
          <p>السعي لتطوير المهارات والمعرفة كل يوم بنسبة 1%، فالتوقف يعني التراجع.</p>
        </div>
        <div class="card">
          <h3>صنع الاستثناء</h3>
          <p>لا نتبع المعايير، بل نضع معاييرنا الخاصة لنتجاوز التوقعات في أي سياق.</p>
        </div>
        <div class="card">
          <h3>التركيز على الهدف</h3>
          <p>كل قرار يُقاس بمدى قربه من الإنجاز النهائي، لا تشتيت.</p>
        </div>
        <!-- Designer-Focused Cards -->
        <div class="card">
          <h3>التفكير الإبداعي</h3>
          <p>نكسر القوالب النمطية لإنتاج حلول مرئية فريدة ومؤثرة.</p>
        </div>
        <div class="card">
          <h3>الجودة أولاً</h3>
          <p>التفاصيل الدقيقة هي الفارق بين العمل الجيد والعمل الاستثنائي الخالد.</p>
        </div>
        <div class="card">
          <h3>إدارة المشاريع</h3>
          <p>تنظيم الوقت والموارد لضمان تسليم الأعمال في مواعيدها وبكفاءة.</p>
        </div>
        <div class="card">
          <h3>المرونة والاستجابة</h3>
          <p>التكيف مع متطلبات العملاء والتغذية الراجعة بمهنية عالية وفعالية.</p>
        </div>
      </div>

      <div class="lockContact">
        <p>هل تمتلك مفتاح الاتصال السري؟</p>
        <input id="passKey" type="password" placeholder="أدخل الرمز" maxlength="3">
        <button onclick="checkPass()">فتح الاتصال</button> 
      </div>
      <div id="contactForm">
        <form onsubmit="sendMessage(event)">
          <input type="text" placeholder="الاسم" required>
          <input type="email" placeholder="البريد الإلكتروني" required>
          <textarea rows="4" placeholder="الرسالة" required></textarea>
          <button type="submit">إرسال الرسالة السرية</button>
        </form>
      </div>
    </section>

    <section id="business">
      <h2 class="section-title">الخدمات والتواصل</h2>
      <p class="section-subtitle">أنا Haider، مصمم غرافيك متخصص في بناء الهويات البصرية القوية.</p>
      
      <h3 style="text-align:center;margin-bottom:1.5rem;font-family:var(--fontH);color:var(--accent);">الخدمات الأساسية</h3>
      <div class="cards" style="margin-bottom: 3rem;">
        <div class="card">
          <h3>تصميم الشعارات (Logo Design)</h3>
          <p>بناء شعارات خالدة ومبتكرة تعكس بوضوح قيم ورؤية علامتك التجارية.</p>
        </div>
        <div class="card">
          <h3>تطوير الهوية البصرية</h3>
          <p>إنشاء دليل متكامل للعلامة التجارية (Branding) يشمل الخطوط والألوان والأنماط.</p>
        </div>
        <div class="card">
          <h3>الحملات الإعلانية الرقمية</h3>
          <p>تصميم إعلانات ومنشورات جاذبة ومعدلة لمنصات السوشيال ميديا ووسائل الإعلام.</p>
        </div>
        <div class="card">
          <h3>تنسيق المطبوعات والمحتوى</h3>
          <p>تصميم احترافي للكتيبات، التقارير، العروض التقديمية والملفات القابلة للطباعة.</p>
        </div>
      </div>

      <h3 style="text-align:center;margin-bottom:1.5rem;font-family:var(--fontH);color:var(--accent);">لماذا تختار Haider؟</h3>
      <div class="cards" style="margin-bottom: 3rem;">
        <div class="card">
            <h3>الإتقان التقني</h3>
            <p>استخدام أحدث برامج وأدوات التصميم لضمان أعلى مستويات الدقة والجودة في الإخراج النهائي.</p>
        </div>
        <div class="card">
            <h3>الاحترافية في التعامل</h3>
            <p>الالتزام بالمواعيد، وتقديم تحديثات منتظمة، والتعامل بمرونة مع التعديلات المطلوبة.</p>
        </div>
        <div class="card">
            <h3>الفهم الاستراتيجي</h3>
            <p>لا نصمم فقط، بل نفهم أهدافك التسويقية لإنشاء تصاميم تحقق نتائج ملموسة.</p>
        </div>
      </div>


      <div style="text-align:center;">
        <p>للشراكات والمشاريع، تواصل عبر النموذج أدناه:</p>
        <form onsubmit="sendMessage(event)">
          <input type="text" placeholder="الاسم الكامل" required>
          <input type="email" placeholder="البريد الإلكتروني" required>
          <input type="text" placeholder="المشروع / نوع الخدمة المطلوبة">
          <textarea rows="4" placeholder="تفاصيل الاستفسار (الرجاء الشرح بالتفصيل)" required></textarea>
          <button type="submit">طلب عرض سعر</button>
        </form>
      </div>
    </section>
  </main>

  <!-- AI CHAT WINDOW V6 -->
  <div class="aiChat" onclick="toggleChat()" aria-label="Open AI Chat"> 
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10 20L14 20" />
        <path d="M12 17L12 20" />
        <rect x="5" y="4" width="14" height="13" rx="2" ry="2" />
        <path d="M15 9L9 9" />
        <path d="M9 13L15 13" />
    </svg>
  </div>
  <div class="chatWindow" id="chatWin">
    <div class="chatHeader">Gemini AI - M.A.K.E.R <span class="chatClose" onclick="toggleChat()">×</span></div>
    <div class="chatBody" id="chatBody">
        <div class="msg-ai">
            <b>Gemini:</b> مرحباً Haider، أنا مساعدك الذكي M.A.K.E.R (Mentality & Knowledge Engine for والرؤية). كيف يمكنني دعم رؤيتك اليوم؟
        </div>
    </div>
    <form class="chatInput" onsubmit="askGemini(event)">
      <input id="chatInp" type="text" placeholder="اطرح سؤالك عن الرؤية أو خدمات التصميم..." required>
      <button type="submit">إرسال</button>
    </form>
  </div>

  <script>
    /* Global Constants for Gemini API */
    const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
    const apiKey = ""; 
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

    /* System Instruction V6: Updated for Graphic Design services */
    const geminiSystemPrompt = "Act as a highly professional, visionary, and supportive AI assistant named M.A.K.E.R (Mentality & Knowledge Engine for والرؤية). Your role is to provide inspiration, strategic guidance, and high-impact responses. You must support the 'EXCEPTION MAKER' project's themes (self-discipline, continuous learning, making the exception) and articulate Haider's value proposition as a professional Graphic Designer specialized in Logo, Branding, and Ads. Respond concisely, exclusively in professional, clear Arabic, using appropriate Markdown for formatting (bolding key concepts).";
    
    // Simple state management for chat history
    let chatHistory = [];
    chatHistory.push({ role: "model", text: "مرحباً Haider، أنا مساعدك الذكي M.A.K.E.R (Mentality & Knowledge Engine for والرؤية). كيف يمكنني دعم رؤيتك اليوم؟" });


    /* Helper function for custom modal */
    function customAlert(message) {
        const modalId = 'custom-modal';
        let modal = document.getElementById(modalId);
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(3, 7, 18, 0.9); z-index: 9999; 
                display: flex; justify-content: center; align-items: center;
            `;
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--card-bg); border: 1px solid var(--accent); padding: 30px; 
                border-radius: 10px; max-width: 90%; color: var(--text-color); text-align: center;
                box-shadow: var(--accentGlow);
            `;
            const msg = document.createElement('p');
            msg.style.marginBottom = '20px';
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'حسناً';
            closeBtn.style.cssText = `
                background: var(--accent); color: var(--bg); padding: 10px 20px; 
                border-radius: 6px; font-weight: bold; cursor: pointer; transition: .3s;
            `;
            closeBtn.onclick = () => modal.remove();
            
            content.appendChild(msg);
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        const isLight = document.body.classList.contains('light');
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent');
        const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg');
        
        modal.style.backgroundColor = isLight ? 'rgba(0,0,0,0.5)' : 'rgba(3, 7, 18, 0.9)';
        modal.querySelector('div').style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--card-bg');
        modal.querySelector('div').style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
        modal.querySelector('div').style.borderColor = accentColor;
        modal.querySelector('div').style.boxShadow = isLight ? '0 0 10px rgba(0,0,0,0.2)' : `0 0 20px ${accentColor}`;

        modal.querySelector('button').style.backgroundColor = accentColor;
        modal.querySelector('button').style.color = bgColor;
        
        modal.querySelector('p').textContent = message;
        modal.style.display = 'flex';
    }


    /* ---------- PARTICLE FLOW (3D Background) - OPTIMIZED ---------- */
    const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
    const PARTICLE_COUNT = 70; 
    const CONNECTION_DISTANCE = 100; 
    let w,h,particles=[],mouse={x:0,y:0};
    function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;}
    addEventListener('resize',resize);resize();
    class P{
      constructor(){
        this.x=Math.random()*w;this.y=Math.random()*h;
        this.vx=(Math.random()-0.5)*.7;this.vy=(Math.random()-0.5)*.7;
        this.r=Math.random()*1.5+1;
      }
      update(){
        this.x+=this.vx;this.y+=this.vy;
        if(this.x<0||this.x>w)this.vx*=-1;
        if(this.y<0||this.y>h)this.vy*=-1;
      }
      draw(){
        const isLight = document.body.classList.contains('light');
        ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
        
        if (isLight) {
             ctx.fillStyle='rgba(0,0,0,.3)';
             ctx.shadowBlur=0;
        } else {
             ctx.fillStyle='rgba(0,240,255,.6)'; 
             ctx.shadowBlur=8;ctx.shadowColor='#00F0FF';
        }
        ctx.fill();
      }
    }
    function init(){particles=[];for(let i=0;i<PARTICLE_COUNT;i++)particles.push(new P());}
    function animate(){
      ctx.clearRect(0,0,w,h);
      particles.forEach(p=>{p.update();p.draw();});
      
      const isLight = document.body.classList.contains('light');
      
      for(let i=0;i<particles.length;i++){
        for(let j=i+1;j<particles.length;j++){
          const dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y,d=Math.hypot(dx,dy);
          if(d<CONNECTION_DISTANCE){
            ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);
            ctx.lineTo(particles[j].x,particles[j].y);
            
            const lineOpacity = 1 - d / CONNECTION_DISTANCE;
            const lineColor = isLight ? 'rgba(100, 100, 100' : 'rgba(0,240,255';
            ctx.strokeStyle=`${lineColor},${lineOpacity * 0.5})`; 
            ctx.lineWidth = 0.5;
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(animate);
    }
    init();
    
    /* ---------- INIT AND HANDLERS ---------- */
    window.onload = function() {
        animate(); 
        animateBars(); 
        renderChatHistory(); 
    }; 
    addEventListener('mousemove',e=>{mouse.x=e.x;mouse.y=e.y;});

    /* ---------- THEME TOGGLE FUNCTION ---------- */
    function toggleTheme(){
        document.body.classList.toggle('light');
    }

    /* ---------- VIEW SWITCHER ---------- */
    function showView(v){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      document.getElementById(v).classList.add('active');
      if(v==='vision')animateBars();
      
      const main = document.querySelector('main');
      window.scrollTo({
          top: main.offsetTop,
          behavior: 'smooth' 
      });
    }

    /* ---------- PROGRESS BARS ---------- */
    function animateBars(){
      document.querySelectorAll('.bar span').forEach(bar=>{
        const target=+bar.dataset.width;
        setTimeout(()=>bar.style.width=target+'%',200);
        
        const label=bar.parentElement.parentElement.querySelector('label span:last-child');
        let curr=0;const inc=target/60;
        const counter=setInterval(()=>{
          curr+=inc;if(curr>=target){curr=target;clearInterval(counter);}
          label.textContent=Math.round(curr)+'%';
        },20);
      });
    }

    /* ---------- PASS CHECK & CONTACT FORM ---------- */
    function checkPass(){
      const val=document.getElementById('passKey').value.trim();
      // The secret code
      if(val==='127'){ 
        document.getElementById('contactForm').style.display='block';
        document.getElementById('passKey').value='';
        customAlert('تم فتح بوابة الاتصال الحصري بنجاح. أهلاً بك.');
      }else{
        customAlert('رمز الوصول غير صحيح. يرجى المحاولة مرة أخرى.');
        document.getElementById('passKey').value='';
      }
    }

    function sendMessage(e){
      e.preventDefault();
      customAlert('تم استلام طلبك/رسالتك بنجاح. سيتم التواصل معك في أقرب وقت.');
      e.target.reset();
      if (e.target.closest('#contactForm')) {
         e.target.closest('#contactForm').style.display = 'none';
      }
    }

    /* ---------- AI CHAT IMPLEMENTATION (GEMINI API) V6 ---------- */

    function renderChatHistory() {
        const body = document.getElementById('chatBody');
        body.innerHTML = '';
        
        chatHistory.forEach(msg => {
            let content = msg.text;
            let sourcesHTML = '';

            if (msg.sources && msg.sources.length > 0) {
                sourcesHTML += `<small>المصادر:`;
                msg.sources.forEach((s, index) => {
                    sourcesHTML += `<br><a href="${s.uri}" target="_blank">[${index + 1}] ${s.title}</a>`;
                });
                sourcesHTML += `</small>`;
            }

            if (msg.role === 'user') {
                body.innerHTML += `<div class="msg-user"><b>أنت:</b> ${content}</div>`;
            } else {
                body.innerHTML += `<div class="msg-ai"><b>Gemini:</b> ${content} ${sourcesHTML}</div>`;
            }
        });
        body.scrollTop = body.scrollHeight;
    }

    function toggleChat(){
      const win=document.getElementById('chatWin');
      win.style.display=win.style.display==='flex'?'none':'flex';
    }
    
    async function askGemini(e){
      e.preventDefault();
      const inp=document.getElementById('chatInp');
      const q=inp.value.trim();
      if(!q) return;
      
      chatHistory.push({ role: "user", text: q });
      inp.value='';
      renderChatHistory();

      const body = document.getElementById('chatBody');
      const loadingMessageId = 'loading-temp';
      body.innerHTML += `<div id="${loadingMessageId}" class="msg-ai" style="color: var(--accent); opacity: 1;"><b>Gemini:</b> جارٍ تحليل هدفك...</div>`;
      body.scrollTop = body.scrollHeight;

      let responseText = null;
      let sources = [];

      for (let i = 0; i < 3; i++) { 
          try {
              const payload = {
                  contents: chatHistory.map(msg => ({ 
                      role: msg.role === 'user' ? 'user' : 'model', 
                      parts: [{ text: msg.text }] 
                  })), 
                  tools: [{ "google_search": {} }], 
                  systemInstruction: {
                      parts: [{ text: geminiSystemPrompt }]
                  },
              };

              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });

              if (!response.ok) {
                  if (response.status === 429 && i < 2) {
                      const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                      await new Promise(resolve => setTimeout(resolve, delay));
                      continue; 
                  }
                  throw new Error(`HTTP error! status: ${response.status}`);
              }

              const result = await response.json();
              const candidate = result.candidates?.[0];

              if (candidate && candidate.content?.parts?.[0]?.text) {
                  responseText = candidate.content.parts[0].text;

                  const groundingMetadata = candidate.groundingMetadata;
                  if (groundingMetadata && groundingMetadata.groundingAttributions) {
                      sources = groundingMetadata.groundingAttributions
                          .map(attribution => ({
                              uri: attribution.web?.uri,
                              title: attribution.web?.title,
                          }))
                          .filter(source => source.uri && source.title);
                  }
                  break; 
              } else {
                  throw new Error("Received an empty response from the model.");
              }

          } catch (error) {
              console.error("Gemini API call failed:", error);
              if (i === 2) {
                  responseText = "عذراً، حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى مراجعة اتصالك والمحاولة مجدداً.";
              }
          }
      }

      document.getElementById(loadingMessageId)?.remove();
      
      const finalResponse = { 
          role: "model", 
          text: responseText, 
          sources: sources 
      };
      chatHistory.push(finalResponse);

      renderChatHistory();
    }
  </script>
</body>
</html>
